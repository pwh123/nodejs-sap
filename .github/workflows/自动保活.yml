name: 自动保活 SAP
on:
  workflow_dispatch:
    inputs:
      domain:  # 手动触发时可指定域名（可选）
        description: '指定需要处理的域名（如 asg.pwh.xx.kg 或 aus.pwh.xx.kg）'
        required: false
        type: string
  repository_dispatch:
    types: [argo-tunnel-down]

jobs:
  determine-region:
    runs-on: ubuntu-latest
    outputs:
      region: ${{ steps.get-region.outputs.region }}  # 输出目标区域（sg/us/all）
    steps:
      - name: 解析目标区域
        id: get-region
        run: |
          # 从事件中获取域名（自动触发从client_payload，手动触发从input）
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            domain="${{ github.event.client_payload.domain }}"
          else
            domain="${{ github.event.inputs.domain }}"
          fi

          # 根据域名判断区域
          if [[ "$domain" == "asg.pwh.xx.kg" ]]; then
            echo "region=sg" >> $GITHUB_OUTPUT
          elif [[ "$domain" == "aus.pwh.xx.kg" ]]; then
            echo "region=us" >> $GITHUB_OUTPUT
          else
            # 手动触发未指定域名或域名不匹配时，默认重启所有区域
            echo "region=all" >> $GITHUB_OUTPUT
          fi

  restart-sg-apps:
    needs: determine-region
    if: needs.determine-region.outputs.region == 'sg' || needs.determine-region.outputs.region == 'all'
    runs-on: ubuntu-latest
    name: Restart SG Apps
    continue-on-error: true
    steps:
      - name: Check Trigger Event
        run: |
          echo "触发域名: ${{ github.event.client_payload.domain || github.event.inputs.domain || '未指定' }}"
          echo "目标区域: SG"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install CF CLI
        run: |
          wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
          echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
          sudo apt-get update
          sudo apt-get install -y cf8-cli

      - name: Determine CF API endpoint
        run: |
          echo "CF_API=https://api.cf.ap21.hana.ondemand.com" >> $GITHUB_ENV
          echo "使用API端点: $CF_API (区域: SG)"

      - name: Login to Cloud Foundry
        run: |
          cf login -a ${{ env.CF_API }} -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}" -o "${{ secrets.SG_ORG }}" -s "${{ secrets.SPACE }}"

      - name: Get all applications
        id: get-sg-apps
        run: |
          apps=$(cf apps | awk 'NR>3 {print $1}' | grep -v '^$')
          echo "发现的应用:"
          echo "$apps"
          echo "apps<<EOF" >> $GITHUB_OUTPUT
          echo "$apps" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Restart SG applications
        run: |
          apps="${{ steps.get-sg-apps.outputs.apps }}"
          if [ -z "$apps" ]; then
            echo "SG区域未找到应用"
            exit 0
          fi
          for app in $apps; do
            echo "重启SG应用: $app"
            cf restart "$app"
            sleep 20
          done

      - name: Verify SG status
        run: cf apps

  restart-us-apps:
    needs: determine-region
    if: needs.determine-region.outputs.region == 'us' || needs.determine-region.outputs.region == 'all'
    runs-on: ubuntu-latest
    name: Restart US Apps
    continue-on-error: true
    steps:
      - name: Check Trigger Event
        run: |
          echo "触发域名: ${{ github.event.client_payload.domain || github.event.inputs.domain || '未指定' }}"
          echo "目标区域: US"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install CF CLI
        run: |
          wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
          echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
          sudo apt-get update
          sudo apt-get install -y cf8-cli

      - name: Determine CF API endpoint
        run: |
          echo "CF_API=https://api.cf.us10-001.hana.ondemand.com" >> $GITHUB_ENV
          echo "使用API端点: $CF_API (区域: US)"

      - name: Login to Cloud Foundry
        run: |
          cf login -a ${{ env.CF_API }} -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}" -o "${{ secrets.US_ORG }}" -s "${{ secrets.SPACE }}"

      - name: Get all applications
        id: get-us-apps
        run: |
          apps=$(cf apps | awk 'NR>3 {print $1}' | grep -v '^$')
          echo "发现的应用:"
          echo "$apps"
          echo "apps<<EOF" >> $GITHUB_OUTPUT
          echo "$apps" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Restart US applications
        run: |
          apps="${{ steps.get-us-apps.outputs.apps }}"
          if [ -z "$apps" ]; then
            echo "US区域未找到应用"
            exit 0
          fi
          for app in $apps; do
            echo "重启US应用: $app"
            cf restart "$app"
            sleep 20
          done

      - name: Verify US status
        run: | 
          apps=$(cf apps | awk 'NR>3 {print $1}'
          for app in $apps; do
            echo "正在重启应用: $app"
            cf restart "$app"
            echo "应用 $app 重启成功"
            echo "----------------------------------------"
            sleep 20  # 每个应用之间等待 20 秒
          done
      - name: Verify applications status
        run: |
          echo "区域 SG 中所有应用的最终状态:"
          cf apps

  restart-us-apps-rey:  # 修正：确保与上一个任务缩进一致（同级）
    runs-on: ubuntu-latest
    name: Restart US Apps
    if: always()
    continue-on-error: true
    steps:
      - name: Check Trigger Event
        run: |
          echo "Workflow triggered by: ${{ github.event_name }}"
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "触发事件类型 (Event Type): ${{ github.event.action }}"
            echo "收到来自 Argo 隧道的下线通知，开始执行自动恢复部署流程..."
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "工作流被手动触发，开始执行部署..."
          else
            echo "工作流由计划任务触发，开始执行部署..."
          fi
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install CF CLI
        run: |
          wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
          echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
          sudo apt-get update
          sudo apt-get install -y cf8-cli
      - name: Determine CF API endpoint
        run: |
          echo "CF_API=https://api.cf.us10-001.hana.ondemand.com" >> $GITHUB_ENV
          echo "使用API端点: $CF_API (区域: US)"
      - name: Login to Cloud Foundry
        run: |
          cf login -a ${{ env.CF_API }} -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}" -o "${{ secrets.US_ORG }}" -s "${{ secrets.SPACE }}"
      - name: Get all applications
        id: get-us-apps
        run: |
          # 获取所有应用名称（跳过前 3 行提示和表头）
          apps=$(cf apps | awk 'NR>3 {print $1}' | grep -v '^$')
          echo "发现的应用:"
          echo "$apps"

          # 直接输出到 GITHUB_OUTPUT（多行字符串）
          echo "apps<<EOF" >> $GITHUB_OUTPUT
          echo "$apps" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Restart all applications
        run: |
          # 从上一步获取应用列表
          apps="${{ steps.get-us-apps.outputs.apps }}"

          if [ -z "$apps" ]; then
            echo "在区域 US 中未找到任何应用"
            exit 0
          fi

          echo "重启区域 US 中的应用:"
          echo "$apps"

          # 重启每个应用
          for app in $apps; do
            echo "正在重启应用: $app"
            cf restart "$app"
            echo "应用 $app 重启成功"
            echo "----------------------------------------"
            sleep 20  # 每个应用之间等待 20 秒
          done
      - name: Verify applications status
        run: |
          echo "区域 US 中所有应用的最终状态:"
          cf apps
