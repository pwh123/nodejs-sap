name: è‡ªåŠ¨éƒ¨ç½² SAP3

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

env:
  IMAGE: ghcr.io/eooce/nodejs-argo:latest
  MEMORY: 2048M
  BASE_PREFIX_SG: "sgsapfixd"  # æ–°åŠ å¡
  BASE_PREFIX_US: "ussapfixd"  # ç¾å›½

jobs:
  deploy_all_regions:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install CF CLI
        run: |
          wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
          echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
          sudo apt-get update
          sudo apt-get install -y cf8-cli

      # æ–°åŠ å¡åŒºåŸŸéƒ¨ç½²
      - name: éƒ¨ç½²æ–°åŠ å¡åŒºåŸŸ
        run: |
          # é…ç½®æ–°åŠ å¡å‚æ•°
          CF_API="https://api.cf.ap21.hana.ondemand.com"
          APP_NAME="${{ env.BASE_PREFIX_SG }}"
          TARGET_ORG="${{ secrets.SG_ORG }}"
          TARGET_SPACE="${{ secrets.SG_SPACE }}"
          
          echo "å¼€å§‹éƒ¨ç½²æ–°åŠ å¡åŒºåŸŸï¼š$APP_NAME"
          
          # 1. ç™»å½•APIç«¯ç‚¹ï¼ˆä¸æŒ‡å®šç»„ç»‡ï¼Œå…ˆéªŒè¯æƒé™ï¼‰
          echo "ç™»å½•æ–°åŠ å¡APIç«¯ç‚¹ï¼š$CF_API"
          if ! cf login -a "$CF_API" -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}"; then
            echo "âŒ ç™»å½•APIç«¯ç‚¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·å/å¯†ç "
            exit 1
          fi
          
          # 2. åˆ—å‡ºå½“å‰ç”¨æˆ·å¯è®¿é—®çš„æ‰€æœ‰ç»„ç»‡ï¼ˆä¾¿äºæ’æŸ¥ï¼‰
          echo "ğŸ“‹ å½“å‰ç”¨æˆ·å¯è®¿é—®çš„æ–°åŠ å¡ç»„ç»‡åˆ—è¡¨ï¼š"
          cf orgs
          
          # 3. éªŒè¯ç›®æ ‡ç»„ç»‡æ˜¯å¦å­˜åœ¨
          echo "éªŒè¯ç»„ç»‡ $TARGET_ORG æ˜¯å¦å­˜åœ¨..."
          if ! cf org "$TARGET_ORG" >/dev/null 2>&1; then
            echo "âŒ ç»„ç»‡ $TARGET_ORG ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥secrets.SG_ORGé…ç½®"
            exit 1
          fi
          echo "âœ… ç»„ç»‡ $TARGET_ORG å­˜åœ¨"
          
          # 4. åˆ‡æ¢åˆ°ç›®æ ‡ç»„ç»‡
          cf target -o "$TARGET_ORG"
          
          # 5. æ£€æŸ¥å¹¶åˆ›å»ºç©ºé—´
          if ! cf space "$TARGET_SPACE" >/dev/null 2>&1; then
            echo "åˆ›å»ºæ–°åŠ å¡ç©ºé—´ $TARGET_SPACE..."
            cf create-space "$TARGET_SPACE" || { echo "âŒ ç©ºé—´åˆ›å»ºå¤±è´¥"; exit 1; }
          else
            echo "âœ… æ–°åŠ å¡ç©ºé—´ $TARGET_SPACE å·²å­˜åœ¨"
          fi
          cf target -s "$TARGET_SPACE"
          
          # 6. éƒ¨ç½²åº”ç”¨åŠåç»­æ­¥éª¤
          cf push "$APP_NAME" --docker-image ${{ env.IMAGE }} -m ${{ env.MEMORY }} --health-check-type port
          
          cf set-env "$APP_NAME" NAME "SAP"
          cf set-env "$APP_NAME" NEZHA_SERVER "${{ secrets.NEZHA_SERVER }}"
          cf set-env "$APP_NAME" NEZHA_PORT "${{ secrets.NEZHA_PORT }}"
          cf set-env "$APP_NAME" NEZHA_KEY "${{ secrets.NEZHA_KEY }}"
          cf set-env "$APP_NAME" UUID "${{ secrets.UUID_SG }}"
          cf set-env "$APP_NAME" ARGO_DOMAIN "${{ secrets.ARGO_DOMAIN_SG }}"
          
          cf restage "$APP_NAME"
          echo "âœ… æ–°åŠ å¡åŒºåŸŸéƒ¨ç½²å®Œæˆ"

      # ç¾å›½åŒºåŸŸéƒ¨ç½²ï¼ˆåŒæ ·å¢åŠ ç»„ç»‡éªŒè¯é€»è¾‘ï¼‰
      - name: éƒ¨ç½²ç¾å›½åŒºåŸŸ
        run: |
          # é…ç½®ç¾å›½å‚æ•°
          CF_API="https://api.cf.us10-001.hana.ondemand.com"
          APP_NAME="${{ env.BASE_PREFIX_US }}"
          TARGET_ORG="${{ secrets.US_ORG }}"
          TARGET_SPACE="${{ secrets.US_SPACE }}"
          
          echo "å¼€å§‹éƒ¨ç½²ç¾å›½åŒºåŸŸï¼š$APP_NAME"
          
          # 1. ç™»å½•APIç«¯ç‚¹
          echo "ç™»å½•ç¾å›½APIç«¯ç‚¹ï¼š$CF_API"
          if ! cf login -a "$CF_API" -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}"; then
            echo "âŒ ç™»å½•APIç«¯ç‚¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·å/å¯†ç "
            exit 1
          fi
          
          # 2. åˆ—å‡ºå¯è®¿é—®ç»„ç»‡
          echo "ğŸ“‹ å½“å‰ç”¨æˆ·å¯è®¿é—®çš„ç¾å›½ç»„ç»‡åˆ—è¡¨ï¼š"
          cf orgs
          
          # 3. éªŒè¯ç›®æ ‡ç»„ç»‡
          echo "éªŒè¯ç»„ç»‡ $TARGET_ORG æ˜¯å¦å­˜åœ¨..."
          if ! cf org "$TARGET_ORG" >/dev/null 2>&1; then
            echo "âŒ ç»„ç»‡ $TARGET_ORG ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥secrets.US_ORGé…ç½®"
            exit 1
          fi
          echo "âœ… ç»„ç»‡ $TARGET_ORG å­˜åœ¨"
          
          # 4. åˆ‡æ¢ç»„ç»‡å’Œç©ºé—´
          cf target -o "$TARGET_ORG"
          
          if ! cf space "$TARGET_SPACE" >/dev/null 2>&1; then
            echo "åˆ›å»ºç¾å›½ç©ºé—´ $TARGET_SPACE..."
            cf create-space "$TARGET_SPACE" || { echo "âŒ ç©ºé—´åˆ›å»ºå¤±è´¥"; exit 1; }
          else
            echo "âœ… ç¾å›½ç©ºé—´ $TARGET_SPACE å·²å­˜åœ¨"
          fi
          cf target -s "$TARGET_SPACE"
          
          # 5. éƒ¨ç½²åº”ç”¨åŠåç»­æ­¥éª¤
          cf push "$APP_NAME" --docker-image ${{ env.IMAGE }} -m ${{ env.MEMORY }} --health-check-type port
          
          cf set-env "$APP_NAME" NAME "SAP"
          cf set-env "$APP_NAME" NEZHA_SERVER "${{ secrets.NEZHA_SERVER }}"
          cf set-env "$APP_NAME" NEZHA_PORT "${{ secrets.NEZHA_PORT }}"
          cf set-env "$APP_NAME" NEZHA_KEY "${{ secrets.NEZHA_KEY }}"
          cf set-env "$APP_NAME" UUID "${{ secrets.UUID_US }}"
          cf set-env "$APP_NAME" ARGO_DOMAIN "${{ secrets.ARGO_DOMAIN_US }}"
          
          cf restage "$APP_NAME"
          echo "âœ… ç¾å›½åŒºåŸŸéƒ¨ç½²å®Œæˆ"

      - name: éªŒè¯æ‰€æœ‰åŒºåŸŸéƒ¨ç½²ç»“æœ
        run: |
          echo "æ‰€æœ‰åŒºåŸŸéƒ¨ç½²å·²å®Œæˆï¼Œå¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹è¯¦æƒ…ï¼š"
          echo "æ–°åŠ å¡åŒºåŸŸï¼šcf app ${{ env.BASE_PREFIX_SG }} -a https://api.cf.ap21.hana.ondemand.com"
          echo "ç¾å›½åŒºåŸŸï¼šcf app ${{ env.BASE_PREFIX_US }} -a https://api.cf.us10-001.hana.ondemand.com"
