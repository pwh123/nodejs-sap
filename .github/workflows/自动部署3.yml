name: è‡ªåŠ¨éƒ¨ç½² SAP3
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

env:
  IMAGE: ghcr.io/eooce/nodejs-argo:latest
  MEMORY: 512M
  APP_NAME_SG: "sgsapfixd"  # æ–°åŠ å¡å›ºå®šåº”ç”¨å
  APP_NAME_US: "ussapfixd"  # ç¾å›½å›ºå®šåº”ç”¨å
  TARGET_SPACE: "dev"       # å›ºå®šç©ºé—´å
  ORG_MATCH_PATTERN: "trial|prod"  # ç»„ç»‡åŒ¹é…è§„åˆ™

jobs:
  deploy_all_regions:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install CF CLI
        run: |
          wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
          echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
          sudo apt-get update && sudo apt-get install -y cf8-cli

      # æ–°åŠ å¡åŒºåŸŸéƒ¨ç½²ï¼ˆå®Œæ•´å˜é‡æ³¨å…¥ï¼‰
      - name: éƒ¨ç½²æ–°åŠ å¡åŒºåŸŸ
        id: deploy_sg
        timeout-minutes: 5  # è¶…æ—¶æ—¶é—´ï¼ˆå¯ä¿®æ”¹ï¼‰
        continue-on-error: true
        run: |
          CF_API="https://api.cf.ap21.hana.ondemand.com"
          APP_NAME="${{ env.APP_NAME_SG }}"
          
          echo "ç™»å½•æ–°åŠ å¡APIç«¯ç‚¹..."
          # ä½¿ç”¨EMAILå’ŒPASSWORDå˜é‡ç™»å½•
          cf login -a "$CF_API" -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}"
          
          # åŠ¨æ€è·å–ç»„ç»‡
          TARGET_ORG=$(cf orgs | grep -E "${{ env.ORG_MATCH_PATTERN }}" | head -n 1)
          if [ -z "$TARGET_ORG" ]; then
            echo "âŒ æœªæ‰¾åˆ°åŒ¹é…ç»„ç»‡"
            exit 1
          fi
          echo "ä½¿ç”¨ç»„ç»‡ï¼š$TARGET_ORG"
          
          # åˆ‡æ¢ç»„ç»‡å’Œç©ºé—´
          cf target -o "$TARGET_ORG"
          cf create-space -o "$TARGET_ORG" ${{ env.TARGET_SPACE }} || true
          cf target -s ${{ env.TARGET_SPACE }}
          
          # éƒ¨ç½²åº”ç”¨
          cf push "$APP_NAME" --docker-image ${{ env.IMAGE }} -m ${{ env.MEMORY }} --health-check-type port
          
          # æ³¨å…¥æ‰€æœ‰æ–°åŠ å¡åŒºåŸŸå˜é‡
          cf set-env "$APP_NAME" UUID "${{ secrets.UUID_SG }}"
          cf set-env "$APP_NAME" ARGO_DOMAIN "${{ secrets.ARGO_DOMAIN_SG }}"
          cf set-env "$APP_NAME" ARGO_AUTH "${{ secrets.ARGO_AUTH_SG }}"  # ARGO_AUTH_SGå˜é‡
          cf set-env "$APP_NAME" SUB_PATH "${{ secrets.SUB_PATH }}"        # é€šç”¨SUB_PATHå˜é‡
          
          # é€šç”¨å˜é‡
          cf set-env "$APP_NAME" NAME "SAP"
          cf set-env "$APP_NAME" NEZHA_SERVER "${{ secrets.NEZHA_SERVER }}"
          cf set-env "$APP_NAME" NEZHA_PORT "${{ secrets.NEZHA_PORT }}"
          cf set-env "$APP_NAME" NEZHA_KEY "${{ secrets.NEZHA_KEY }}"
          
          cf restage "$APP_NAME"
          echo "âœ… æ–°åŠ å¡éƒ¨ç½²å®Œæˆï¼ˆåº”ç”¨åï¼š$APP_NAMEï¼‰"

      # ç¾å›½åŒºåŸŸéƒ¨ç½²ï¼ˆå®Œæ•´å˜é‡æ³¨å…¥ï¼‰
      - name: éƒ¨ç½²ç¾å›½åŒºåŸŸ
        timeout-minutes: 5  # è¶…æ—¶æ—¶é—´ï¼ˆå¯ä¿®æ”¹ï¼‰
        run: |
          CF_API="https://api.cf.us10-001.hana.ondemand.com"
          APP_NAME="${{ env.APP_NAME_US }}"
          
          echo "ç™»å½•ç¾å›½APIç«¯ç‚¹..."
          # ä½¿ç”¨EMAILå’ŒPASSWORDå˜é‡ç™»å½•
          cf login -a "$CF_API" -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}"
          
          # åŠ¨æ€è·å–ç»„ç»‡
          TARGET_ORG=$(cf orgs | grep -E "${{ env.ORG_MATCH_PATTERN }}" | head -n 1)
          if [ -z "$TARGET_ORG" ]; then
            echo "âŒ æœªæ‰¾åˆ°åŒ¹é…ç»„ç»‡"
            exit 1
          fi
          echo "ä½¿ç”¨ç»„ç»‡ï¼š$TARGET_ORG"
          
          # åˆ‡æ¢ç»„ç»‡å’Œç©ºé—´
          cf target -o "$TARGET_ORG"
          cf create-space -o "$TARGET_ORG" ${{ env.TARGET_SPACE }} || true
          cf target -s ${{ env.TARGET_SPACE }}
          
          # éƒ¨ç½²åº”ç”¨
          cf push "$APP_NAME" --docker-image ${{ env.IMAGE }} -m ${{ env.MEMORY }} --health-check-type port
          
          # æ³¨å…¥æ‰€æœ‰ç¾å›½åŒºåŸŸå˜é‡
          cf set-env "$APP_NAME" UUID "${{ secrets.UUID_US }}"
          cf set-env "$APP_NAME" ARGO_DOMAIN "${{ secrets.ARGO_DOMAIN_US }}"
          cf set-env "$APP_NAME" ARGO_AUTH "${{ secrets.ARGO_AUTH_US }}"  # ARGO_AUTH_USå˜é‡
          cf set-env "$APP_NAME" SUB_PATH "${{ secrets.SUB_PATH }}"        # é€šç”¨SUB_PATHå˜é‡
          
          # é€šç”¨å˜é‡
          cf set-env "$APP_NAME" NAME "SAP"
          cf set-env "$APP_NAME" NEZHA_SERVER "${{ secrets.NEZHA_SERVER }}"
          cf set-env "$APP_NAME" NEZHA_PORT "${{ secrets.NEZHA_PORT }}"
          cf set-env "$APP_NAME" NEZHA_KEY "${{ secrets.NEZHA_KEY }}"
          
          cf restage "$APP_NAME"
          echo "âœ… ç¾å›½éƒ¨ç½²å®Œæˆï¼ˆåº”ç”¨åï¼š$APP_NAMEï¼‰"

      - name: éƒ¨ç½²ç»“æœæ±‡æ€»
        run: |
          if [ "${{ steps.deploy_sg.outcome }}" = "success" ]; then
            echo "ğŸ‰ æ–°åŠ å¡ã€ç¾å›½åŒºåŸŸéƒ¨ç½²å®Œæˆ"
          else
            echo "âš ï¸ æ–°åŠ å¡åŒºåŸŸéƒ¨ç½²å¤±è´¥ï¼Œç¾å›½åŒºåŸŸéƒ¨ç½²å®Œæˆ"
          fi
