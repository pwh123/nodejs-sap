name: è‡ªåŠ¨éƒ¨ç½² SAP
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      regions:
        description: 'é€‰æ‹©éƒ¨ç½²åŒºåŸŸï¼ˆå¯å¤šé€‰ï¼‰'
        required: true
        default: 'sg,us'  # é»˜è®¤å…¨é€‰
        type: choice
        options:
          - sg,us  # å…¨éƒ¨åŒºåŸŸ
          - sg     # ä»…æ–°åŠ å¡
          - us     # ä»…ç¾å›½

env:
  IMAGE: ghcr.io/pwh123/nodejs:main
  MEMORY: 512M
  APP_NAME_SG: "sgsapfixd"
  APP_NAME_US: "ussapfixd"
  TARGET_SPACE: "dev"
  NEW_ORG_NAME: "sap-deploy-org"  # æ–°ç»„ç»‡åç§°

jobs:
  deploy_selected_regions:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install CF CLI
        run: |
          wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
          echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
          sudo apt-get update && sudo apt-get install -y cf8-cli

      # æ–°åŠ å¡åŒºåŸŸï¼šåˆ é™¤æ—§ç»„ç»‡ -> åˆ›å»ºæ–°ç»„ç»‡ -> éƒ¨ç½²
      - name: éƒ¨ç½²æ–°åŠ å¡åŒºåŸŸ
        id: deploy_sg
        timeout-minutes: 10
        continue-on-error: true
        if: contains(github.event.inputs.regions, 'sg')
        run: |
          CF_API="https://api.cf.ap21.hana.ondemand.com"
          APP_NAME="${{ env.APP_NAME_SG }}"
          NEW_ORG="${{ env.NEW_ORG_NAME }}-sg"  # åŒºåŸŸåç¼€åŒºåˆ†ç»„ç»‡
          
          echo "ç™»å½•æ–°åŠ å¡APIç«¯ç‚¹..."
          cf login -a "$CF_API" -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}"
          
          # 1. åˆ é™¤æ‰€æœ‰ç°æœ‰ç»„ç»‡ï¼ˆè°¨æ…æ“ä½œï¼ä¼šæ¸…é™¤æ‰€æœ‰èµ„æºï¼‰
          echo "ğŸ—‘ï¸ å¼€å§‹åˆ é™¤æ–°åŠ å¡åŒºåŸŸæ‰€æœ‰ç»„ç»‡..."
          cf orgs | grep -v "name" | awk '{print $1}' | while read org_name; do
            echo "åˆ é™¤ç»„ç»‡: $org_name"
            cf delete-org "$org_name" -f -r  # -r é€’å½’åˆ é™¤æ‰€æœ‰å…³è”èµ„æº
          done
          
          # 2. åˆ›å»ºæ–°ç»„ç»‡
          echo "ğŸ­ åˆ›å»ºæ–°åŠ å¡æ–°ç»„ç»‡: $NEW_ORG"
          cf create-org "$NEW_ORG" || {
            echo "âŒ æ–°åŠ å¡æ–°ç»„ç»‡åˆ›å»ºå¤±è´¥"
            exit 1
          }
          
          # 3. åˆ‡æ¢åˆ°æ–°ç»„ç»‡å¹¶åˆ›å»ºç©ºé—´
          cf target -o "$NEW_ORG"
          cf create-space -o "$NEW_ORG" ${{ env.TARGET_SPACE }} || true
          cf target -s ${{ env.TARGET_SPACE }}
          
          # 4. éƒ¨ç½²åº”ç”¨åŠå˜é‡
          cf push "$APP_NAME" --docker-image ${{ env.IMAGE }} -m ${{ env.MEMORY }} --health-check-type port
          cf set-env "$APP_NAME" UUID "${{ secrets.UUID_SG }}"
          cf set-env "$APP_NAME" ARGO_DOMAIN "${{ secrets.ARGO_DOMAIN_SG }}"
          cf set-env "$APP_NAME" ARGO_AUTH "${{ secrets.ARGO_AUTH_SG }}"
          cf set-env "$APP_NAME" SUB_PATH "${{ secrets.SUB_PATH }}"
          cf set-env "$APP_NAME" NAME "SAP"
          cf set-env "$APP_NAME" NEZHA_SERVER "${{ secrets.NEZHA_SERVER }}"
          cf set-env "$APP_NAME" NEZHA_PORT "${{ secrets.NEZHA_PORT }}"
          cf set-env "$APP_NAME" NEZHA_KEY "${{ secrets.NEZHA_KEY }}"
          
          cf restage "$APP_NAME"
          echo "âœ… æ–°åŠ å¡éƒ¨ç½²å®Œæˆ"

      # ç¾å›½åŒºåŸŸï¼šåˆ é™¤æ—§ç»„ç»‡ -> åˆ›å»ºæ–°ç»„ç»‡ -> éƒ¨ç½²
      - name: éƒ¨ç½²ç¾å›½åŒºåŸŸ
        id: deploy_us
        timeout-minutes: 10
        if: contains(github.event.inputs.regions, 'us')
        run: |
          CF_API="https://api.cf.us10-001.hana.ondemand.com"
          APP_NAME="${{ env.APP_NAME_US }}"
          NEW_ORG="${{ env.NEW_ORG_NAME }}-us"  # åŒºåŸŸåç¼€åŒºåˆ†ç»„ç»‡
          
          echo "ç™»å½•ç¾å›½APIç«¯ç‚¹..."
          cf login -a "$CF_API" -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}"
          
          # 1. åˆ é™¤æ‰€æœ‰ç°æœ‰ç»„ç»‡ï¼ˆè°¨æ…æ“ä½œï¼ä¼šæ¸…é™¤æ‰€æœ‰èµ„æºï¼‰
          echo "ğŸ—‘ï¸ å¼€å§‹åˆ é™¤ç¾å›½åŒºåŸŸæ‰€æœ‰ç»„ç»‡..."
          cf orgs | grep -v "name" | awk '{print $1}' | while read org_name; do
            echo "åˆ é™¤ç»„ç»‡: $org_name"
            cf delete-org "$org_name" -f -r  # -r é€’å½’åˆ é™¤æ‰€æœ‰å…³è”èµ„æº
          done
          
          # 2. åˆ›å»ºæ–°ç»„ç»‡
          echo "ğŸ­ åˆ›å»ºç¾å›½æ–°ç»„ç»‡: $NEW_ORG"
          cf create-org "$NEW_ORG" || {
            echo "âŒ ç¾å›½æ–°ç»„ç»‡åˆ›å»ºå¤±è´¥"
            exit 1
          }
          
          # 3. åˆ‡æ¢åˆ°æ–°ç»„ç»‡å¹¶åˆ›å»ºç©ºé—´
          cf target -o "$NEW_ORG"
          cf create-space -o "$NEW_ORG" ${{ env.TARGET_SPACE }} || true
          cf target -s ${{ env.TARGET_SPACE }}
          
          # 4. éƒ¨ç½²åº”ç”¨åŠå˜é‡
          cf push "$APP_NAME" --docker-image ${{ env.IMAGE }} -m ${{ env.MEMORY }} --health-check-type port
          cf set-env "$APP_NAME" UUID "${{ secrets.UUID_US }}"
          cf set-env "$APP_NAME" ARGO_DOMAIN "${{ secrets.ARGO_DOMAIN_US }}"
          cf set-env "$APP_NAME" ARGO_AUTH "${{ secrets.ARGO_AUTH_US }}"
          cf set-env "$APP_NAME" SUB_PATH "${{ secrets.SUB_PATH }}"
          cf set-env "$APP_NAME" NAME "SAP"
          cf set-env "$APP_NAME" NEZHA_SERVER "${{ secrets.NEZHA_SERVER }}"
          cf set-env "$APP_NAME" NEZHA_PORT "${{ secrets.NEZHA_PORT }}"
          cf set-env "$APP_NAME" NEZHA_KEY "${{ secrets.NEZHA_KEY }}"
          
          cf restage "$APP_NAME"
          echo "âœ… ç¾å›½éƒ¨ç½²å®Œæˆ"

      - name: éƒ¨ç½²ç»“æœæ±‡æ€»
        run: |
          if [ "${{ github.event.inputs.regions }}" = "sg,us" ]; then
            if [ "${{ steps.deploy_sg.outcome }}" = "success" ] && [ "${{ steps.deploy_us.outcome }}" = "success" ]; then
              echo "ğŸ‰ å…¨éƒ¨åŒºåŸŸéƒ¨ç½²å®Œæˆ"
            else
              echo "âš ï¸ éƒ¨åˆ†åŒºåŸŸéƒ¨ç½²å¤±è´¥ï¼ˆæ–°åŠ å¡ï¼š${{ steps.deploy_sg.outcome }}, ç¾å›½ï¼š${{ steps.deploy_us.outcome }}"
            fi
          elif [ "${{ github.event.inputs.regions }}" = "sg" ]; then
            if [ "${{ steps.deploy_sg.outcome }}" = "success" ]; then
              echo "ğŸ‰ æ–°åŠ å¡åŒºåŸŸéƒ¨ç½²å®Œæˆ"
            else
              echo "âš ï¸ æ–°åŠ å¡åŒºåŸŸéƒ¨ç½²å¤±è´¥"
            fi
          else
            if [ "${{ steps.deploy_us.outcome }}" = "success" ]; then
              echo "ğŸ‰ ç¾å›½åŒºåŸŸéƒ¨ç½²å®Œæˆ"
            else
              echo "âš ï¸ ç¾å›½åŒºåŸŸéƒ¨ç½²å¤±è´¥"
            fi
          fi
          cf set-env "$APP_NAME" NAME "SAP"
          cf set-env "$APP_NAME" NEZHA_SERVER "${{ secrets.NEZHA_SERVER }}"
          cf set-env "$APP_NAME" NEZHA_PORT "${{ secrets.NEZHA_PORT }}"
          cf set-env "$APP_NAME" NEZHA_KEY "${{ secrets.NEZHA_KEY }}"
          
          cf restage "$APP_NAME"
          echo "âœ… æ–°åŠ å¡éƒ¨ç½²å®Œæˆ"

      # ç¾å›½åŒºåŸŸéƒ¨ç½²
      - name: éƒ¨ç½²ç¾å›½åŒºåŸŸ
        id: deploy_us
        timeout-minutes: 10
        if: contains(github.event.inputs.regions, 'us')
        run: |
          CF_API="https://api.cf.us10-001.hana.ondemand.com"
          APP_NAME="${{ env.APP_NAME_US }}"
          NEW_ORG="${{ env.NEW_ORG_NAME }}-us"
          
          echo "ç™»å½•ç¾å›½APIç«¯ç‚¹..."
          cf login -a "$CF_API" -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}"
          
          # æ¸…ç†æ—§ç»„ç»‡å’Œç©ºé—´
          echo "ğŸ—‘ï¸ å¼€å§‹æ¸…ç†ç¾å›½åŒºåŸŸæ—§ç»„ç»‡..."
          cf orgs | grep -v "name" | awk '{print $1}' | while read org_name; do
            echo "å¤„ç†ç»„ç»‡: $org_name"
            cf target -o "$org_name"
            # åˆ é™¤ç»„ç»‡ä¸‹æ‰€æœ‰ç©ºé—´
            cf spaces | grep -v "name" | awk '{print $1}' | while read space_name; do
              echo "åˆ é™¤ç©ºé—´: $space_name"
              cf delete-space "$space_name" -f
            done
            # åˆ é™¤ç»„ç»‡
            echo "åˆ é™¤ç»„ç»‡: $org_name"
            cf delete-org "$org_name" -f
          done
          
          # åˆ›å»ºæ–°ç»„ç»‡å’Œç©ºé—´
          echo "ğŸ­ åˆ›å»ºç¾å›½æ–°ç»„ç»‡: $NEW_ORG"
          cf create-org "$NEW_ORG" || {
            echo "âŒ ç¾å›½æ–°ç»„ç»‡åˆ›å»ºå¤±è´¥"
            exit 1
          }
          cf target -o "$NEW_ORG"
          cf create-space -o "$NEW_ORG" ${{ env.TARGET_SPACE }} || true
          cf target -s ${{ env.TARGET_SPACE }}
          
          # éƒ¨ç½²åº”ç”¨åŠè®¾ç½®å˜é‡
          cf push "$APP_NAME" --docker-image ${{ env.IMAGE }} -m ${{ env.MEMORY }} --health-check-type port
          cf set-env "$APP_NAME" UUID "${{ secrets.UUID_US }}"
          cf set-env "$APP_NAME" ARGO_DOMAIN "${{ secrets.ARGO_DOMAIN_US }}"
          cf set-env "$APP_NAME" ARGO_AUTH "${{ secrets.ARGO_AUTH_US }}"
          cf set-env "$APP_NAME" SUB_PATH "${{ secrets.SUB_PATH }}"
          cf set-env "$APP_NAME" NAME "SAP"
          cf set-env "$APP_NAME" NEZHA_SERVER "${{ secrets.NEZHA_SERVER }}"
          cf set-env "$APP_NAME" NEZHA_PORT "${{ secrets.NEZHA_PORT }}"
          cf set-env "$APP_NAME" NEZHA_KEY "${{ secrets.NEZHA_KEY }}"
          
          cf restage "$APP_NAME"
          echo "âœ… ç¾å›½éƒ¨ç½²å®Œæˆ"

      - name: éƒ¨ç½²ç»“æœæ±‡æ€»
        run: |
          if [ "${{ github.event.inputs.regions }}" = "sg,us" ]; then
            if [ "${{ steps.deploy_sg.outcome }}" = "success" ] && [ "${{ steps.deploy_us.outcome }}" = "success" ]; then
              echo "ğŸ‰ å…¨éƒ¨åŒºåŸŸéƒ¨ç½²å®Œæˆ"
            else
              echo "âš ï¸ éƒ¨åˆ†åŒºåŸŸéƒ¨ç½²å¤±è´¥ï¼ˆæ–°åŠ å¡ï¼š${{ steps.deploy_sg.outcome }}, ç¾å›½ï¼š${{ steps.deploy_us.outcome }}"
            fi
          elif [ "${{ github.event.inputs.regions }}" = "sg" ]; then
            if [ "${{ steps.deploy_sg.outcome }}" = "success" ]; then
              echo "ğŸ‰ æ–°åŠ å¡åŒºåŸŸéƒ¨ç½²å®Œæˆ"
            else
              echo "âš ï¸ æ–°åŠ å¡åŒºåŸŸéƒ¨ç½²å¤±è´¥"
            fi
          else
            if [ "${{ steps.deploy_us.outcome }}" = "success" ]; then
              echo "ğŸ‰ ç¾å›½åŒºåŸŸéƒ¨ç½²å®Œæˆ"
            else
              echo "âš ï¸ ç¾å›½åŒºåŸŸéƒ¨ç½²å¤±è´¥"
            fi
          fi
          cf set-env "$APP_NAME" NAME "SAP"
          cf set-env "$APP_NAME" NEZHA_SERVER "${{ secrets.NEZHA_SERVER }}"
          cf set-env "$APP_NAME" NEZHA_PORT "${{ secrets.NEZHA_PORT }}"
          cf set-env "$APP_NAME" NEZHA_KEY "${{ secrets.NEZHA_KEY }}"
          
          cf restage "$APP_NAME"
          echo "âœ… æ–°åŠ å¡éƒ¨ç½²å®Œæˆ"

      # ç¾å›½åŒºåŸŸï¼šåˆ é™¤æ—§ç»„ç»‡ï¼ˆå…¼å®¹æ— -rå‚æ•°ç‰ˆæœ¬ï¼‰-> åˆ›å»ºæ–°ç»„ç»‡ -> éƒ¨ç½²
      - name: éƒ¨ç½²ç¾å›½åŒºåŸŸ
        id: deploy_us
        timeout-minutes: 10
        if: contains(github.event.inputs.regions, 'us')
        run: |
          CF_API="https://api.cf.us10-001.hana.ondemand.com"
          APP_NAME="${{ env.APP_NAME_US }}"
          NEW_ORG="${{ env.NEW_ORG_NAME }}-us"
          
          echo "ç™»å½•ç¾å›½APIç«¯ç‚¹..."
          cf login -a "$CF_API" -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}"
          
          # 1. å…ˆåˆ é™¤ç»„ç»‡ä¸‹æ‰€æœ‰ç©ºé—´ï¼Œå†åˆ é™¤ç»„ç»‡ï¼ˆå…¼å®¹æ— -rå‚æ•°çš„CF CLIï¼‰
          echo "ğŸ—‘ï¸ å¼€å§‹æ¸…ç†ç¾å›½åŒºåŸŸæ—§ç»„ç»‡..."
          cf orgs | grep -v "name" | awk '{print $1}' | while read org_name; do
            echo "å¤„ç†ç»„ç»‡: $org_name"
            cf target -o "$org_name"  # åˆ‡æ¢åˆ°ç›®æ ‡ç»„ç»‡
            # å…ˆåˆ é™¤è¯¥ç»„ç»‡ä¸‹æ‰€æœ‰ç©ºé—´
            cf spaces | grep -v "name" | awk '{print $1}' | while read space_name; do
              echo "åˆ é™¤ç©ºé—´: $space_name"
              cf delete-space "$space_name" -f
            done
            # å†åˆ é™¤ç»„ç»‡
            echo "åˆ é™¤ç»„ç»‡: $org_name"
            cf delete-org "$org_name" -f
          done
          
          # 2. åˆ›å»ºæ–°ç»„ç»‡å’Œç©ºé—´
          echo "ğŸ­ åˆ›å»ºç¾å›½æ–°ç»„ç»‡: $NEW_ORG"
          cf create-org "$NEW_ORG" || {
            echo "âŒ ç¾å›½æ–°ç»„ç»‡åˆ›å»ºå¤±è´¥"
            exit 1
          }
          cf target -o "$NEW_ORG"
          cf create-space -o "$NEW_ORG" ${{ env.TARGET_SPACE }} || true
          cf target -s ${{ env.TARGET_SPACE }}
          
          # 3. éƒ¨ç½²åº”ç”¨åŠå˜é‡
          cf push "$APP_NAME" --docker-image ${{ env.IMAGE }} -m ${{ env.MEMORY }} --health-check-type port
          cf set-env "$APP_NAME" UUID "${{ secrets.UUID_US }}"
          cf set-env "$APP_NAME" ARGO_DOMAIN "${{ secrets.ARGO_DOMAIN_US }}"
          cf set-env "$APP_NAME" ARGO_AUTH "${{ secrets.ARGO_AUTH_US }}"
          cf set-env "$APP_NAME" SUB_PATH "${{ secrets.SUB_PATH }}"
          cf set-env "$APP_NAME" NAME "SAP"
          cf set-env "$APP_NAME" NEZHA_SERVER "${{ secrets.NEZHA_SERVER }}"
          cf set-env "$APP_NAME" NEZHA_PORT "${{ secrets.NEZHA_PORT }}"
          cf set-env "$APP_NAME" NEZHA_KEY "${{ secrets.NEZHA_KEY }}"
          
          cf restage "$APP_NAME"
          echo "âœ… ç¾å›½éƒ¨ç½²å®Œæˆ"

      - name: éƒ¨ç½²ç»“æœæ±‡æ€»
        run: |
          if [ "${{ github.event.inputs.regions }}" = "sg,us" ]; then
            if [ "${{ steps.deploy_sg.outcome }}" = "success" ] && [ "${{ steps.deploy_us.outcome }}" = "success" ]; then
              echo "ğŸ‰ å…¨éƒ¨åŒºåŸŸéƒ¨ç½²å®Œæˆ"
            else
              echo "âš ï¸ éƒ¨åˆ†åŒºåŸŸéƒ¨ç½²å¤±è´¥ï¼ˆæ–°åŠ å¡ï¼š${{ steps.deploy_sg.outcome }}, ç¾å›½ï¼š${{ steps.deploy_us.outcome }}"
            fi
          elif [ "${{ github.event.inputs.regions }}" = "sg" ]; then
            if [ "${{ steps.deploy_sg.outcome }}" = "success" ]; then
              echo "ğŸ‰ æ–°åŠ å¡åŒºåŸŸéƒ¨ç½²å®Œæˆ"
            else
              echo "âš ï¸ æ–°åŠ å¡åŒºåŸŸéƒ¨ç½²å¤±è´¥"
            fi
          else
            if [ "${{ steps.deploy_us.outcome }}" = "success" ]; then
              echo "ğŸ‰ ç¾å›½åŒºåŸŸéƒ¨ç½²å®Œæˆ"
            else
              echo "âš ï¸ ç¾å›½åŒºåŸŸéƒ¨ç½²å¤±è´¥"
            fi
          fi
          # æŸ¥æ‰¾åŒ¹é…ç»„ç»‡ï¼Œæ— åˆ™åˆ›å»º
          TARGET_ORG=$(cf orgs | grep -E "${{ env.ORG_MATCH_PATTERN }}" | head -n 1)
          if [ -z "$TARGET_ORG" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°åŒ¹é…ç»„ç»‡ï¼Œè‡ªåŠ¨åˆ›å»ºé»˜è®¤ç»„ç»‡ï¼š$DEFAULT_ORG"
            cf create-org "$DEFAULT_ORG"
            TARGET_ORG="$DEFAULT_ORG"
          fi
          echo "ä½¿ç”¨ç»„ç»‡ï¼š$TARGET_ORG"
          
          # åˆ‡æ¢ç»„ç»‡å’Œç©ºé—´ï¼ˆç©ºé—´ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
          cf target -o "$TARGET_ORG"
          cf create-space -o "$TARGET_ORG" ${{ env.TARGET_SPACE }} || true
          cf target -s ${{ env.TARGET_SPACE }}
          
          # éƒ¨ç½²åº”ç”¨åŠå˜é‡
          cf push "$APP_NAME" --docker-image ${{ env.IMAGE }} -m ${{ env.MEMORY }} --health-check-type port
          cf set-env "$APP_NAME" UUID "${{ secrets.UUID_SG }}"
          cf set-env "$APP_NAME" ARGO_DOMAIN "${{ secrets.ARGO_DOMAIN_SG }}"
          cf set-env "$APP_NAME" ARGO_AUTH "${{ secrets.ARGO_AUTH_SG }}"
          cf set-env "$APP_NAME" SUB_PATH "${{ secrets.SUB_PATH }}"
          cf set-env "$APP_NAME" NAME "SAP"
          cf set-env "$APP_NAME" NEZHA_SERVER "${{ secrets.NEZHA_SERVER }}"
          cf set-env "$APP_NAME" NEZHA_PORT "${{ secrets.NEZHA_PORT }}"
          cf set-env "$APP_NAME" NEZHA_KEY "${{ secrets.NEZHA_KEY }}"
          
          cf restage "$APP_NAME"
          echo "âœ… æ–°åŠ å¡éƒ¨ç½²å®Œæˆ"

      # ç¾å›½åŒºåŸŸéƒ¨ç½²ï¼ˆå«è‡ªåŠ¨åˆ›å»ºç»„ç»‡é€»è¾‘ï¼‰
      - name: éƒ¨ç½²ç¾å›½åŒºåŸŸ
        id: deploy_us
        timeout-minutes: 5
        if: contains(github.event.inputs.regions, 'us')
        run: |
          CF_API="https://api.cf.us10-001.hana.ondemand.com"
          APP_NAME="${{ env.APP_NAME_US }}"
          # åŒºåŸŸä¸“å±ç»„ç»‡å
          DEFAULT_ORG="${{ env.DEFAULT_ORG_PREFIX }}-us"
          
          echo "ç™»å½•ç¾å›½APIç«¯ç‚¹..."
          cf login -a "$CF_API" -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}"
          
          echo "ğŸ“‹ ç¾å›½åŒºåŸŸå¯è®¿é—®ç»„ç»‡ï¼š"
          cf orgs
          
          # æŸ¥æ‰¾åŒ¹é…ç»„ç»‡ï¼Œæ— åˆ™åˆ›å»º
          TARGET_ORG=$(cf orgs | grep -E "${{ env.ORG_MATCH_PATTERN }}" | head -n 1)
          if [ -z "$TARGET_ORG" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°åŒ¹é…ç»„ç»‡ï¼Œè‡ªåŠ¨åˆ›å»ºé»˜è®¤ç»„ç»‡ï¼š$DEFAULT_ORG"
            cf create-org "$DEFAULT_ORG"
            TARGET_ORG="$DEFAULT_ORG"
          fi
          echo "ä½¿ç”¨ç»„ç»‡ï¼š$TARGET_ORG"
          
          # åˆ‡æ¢ç»„ç»‡å’Œç©ºé—´
          cf target -o "$TARGET_ORG"
          cf create-space -o "$TARGET_ORG" ${{ env.TARGET_SPACE }} || true
          cf target -s ${{ env.TARGET_SPACE }}
          
          # éƒ¨ç½²åº”ç”¨åŠå˜é‡
          cf push "$APP_NAME" --docker-image ${{ env.IMAGE }} -m ${{ env.MEMORY }} --health-check-type port
          cf set-env "$APP_NAME" UUID "${{ secrets.UUID_US }}"
          cf set-env "$APP_NAME" ARGO_DOMAIN "${{ secrets.ARGO_DOMAIN_US }}"
          cf set-env "$APP_NAME" ARGO_AUTH "${{ secrets.ARGO_AUTH_US }}"
          cf set-env "$APP_NAME" SUB_PATH "${{ secrets.SUB_PATH }}"
          cf set-env "$APP_NAME" NAME "SAP"
          cf set-env "$APP_NAME" NEZHA_SERVER "${{ secrets.NEZHA_SERVER }}"
          cf set-env "$APP_NAME" NEZHA_PORT "${{ secrets.NEZHA_PORT }}"
          cf set-env "$APP_NAME" NEZHA_KEY "${{ secrets.NEZHA_KEY }}"
          
          cf restage "$APP_NAME"
          echo "âœ… ç¾å›½éƒ¨ç½²å®Œæˆ"

      - name: éƒ¨ç½²ç»“æœæ±‡æ€»
        run: |
          if [ "${{ github.event.inputs.regions }}" = "sg,us" ]; then
            if [ "${{ steps.deploy_sg.outcome }}" = "success" ] && [ "${{ steps.deploy_us.outcome }}" = "success" ]; then
              echo "ğŸ‰ å…¨éƒ¨åŒºåŸŸéƒ¨ç½²å®Œæˆ"
            else
              echo "âš ï¸ éƒ¨åˆ†åŒºåŸŸéƒ¨ç½²å¤±è´¥ï¼ˆæ–°åŠ å¡ï¼š${{ steps.deploy_sg.outcome }}, ç¾å›½ï¼š${{ steps.deploy_us.outcome }}"
            fi
          elif [ "${{ github.event.inputs.regions }}" = "sg" ]; then
            if [ "${{ steps.deploy_sg.outcome }}" = "success" ]; then
              echo "ğŸ‰ æ–°åŠ å¡åŒºåŸŸéƒ¨ç½²å®Œæˆ"
            else
              echo "âš ï¸ æ–°åŠ å¡åŒºåŸŸéƒ¨ç½²å¤±è´¥"
            fi
          else
            if [ "${{ steps.deploy_us.outcome }}" = "success" ]; then
              echo "ğŸ‰ ç¾å›½åŒºåŸŸéƒ¨ç½²å®Œæˆ"
            else
              echo "âš ï¸ ç¾å›½åŒºåŸŸéƒ¨ç½²å¤±è´¥"
            fi
          fi
