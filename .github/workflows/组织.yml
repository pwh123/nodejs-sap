name: Cloud Foundry
on:
  workflow_dispatch:
    inputs:
      regions:
        description: 'é€‰æ‹©é‡å»ºåŒºåŸŸ'
        required: true
        default: 'sg,us'
        type: choice
        options:
          - sg,us  # åŒæ—¶å¤„ç†æ–°åŠ å¡å’Œç¾å›½
          - sg     # ä»…æ–°åŠ å¡
          - us     # ä»…ç¾å›½

env:
  # é€šç”¨é…ç½®
  ENV_INSTANCE_NAME: "cf-trial"
  SPACE_NAME: "dev"
  BTP_CLI_URL: "https://cpcli.cf.eu10.hana.ondemand.com"
  
  # æ–°åŠ å¡åŒºåŸŸé…ç½®ï¼ˆsgï¼‰
  SUBACCOUNT_ID_SG: "fc63b4dc-2dd2-40fb-92a6-0e82b1b87b45"  # æ–°åŠ å¡å­è´¦æˆ·IDï¼ˆå¯æ ¹æ®å®é™…è°ƒæ•´ï¼‰
  REGION_SG: "ap-southeast-1"  # æ–°åŠ å¡åŒºåŸŸæ ‡è¯†
  CF_API_SG: "https://api.cf.ap21.hana.ondemand.com"  # æä¾›çš„æ–°åŠ å¡APIç«¯ç‚¹
  ORG_NAME_SG: "adac7863trial_adac7863trial_ext"  # æä¾›çš„æ–°åŠ å¡ç»„ç»‡å
  ORG_ID_SG: "80f49179-3d8c-467e-ae73-73f4238e9163"  # æä¾›çš„æ–°åŠ å¡ç»„ç»‡ID
  
  # ç¾å›½åŒºåŸŸé…ç½®ï¼ˆusï¼‰
  SUBACCOUNT_ID_US: "fc63b4dc-2dd2-40fb-92a6-0e82b1b87b45"  # ç¾å›½å­è´¦æˆ·IDï¼ˆå¯æ ¹æ®å®é™…è°ƒæ•´ï¼‰
  REGION_US: "us-east-1"
  CF_API_US: "https://api.cf.us10-001.hana.ondemand.com"
  ORG_NAME_US: "sap-deploy-production-us"

jobs:
  rebuild_cf_environment:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        region: ${{ fromJson(format('["{0}"]', replace(github.event.inputs.regions, ',', '","'))) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: å®‰è£… btp CLI
        run: |
          wget https://github.com/SAP-samples/btp-cli-installer/releases/latest/download/btp-cli-linux-amd64.tar.gz -O btp-cli.tar.gz
          tar -xzf btp-cli.tar.gz
          sudo mv btp /usr/local/bin/

      - name: å®‰è£… cf CLI
        run: |
          wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
          echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
          sudo apt-get update && sudo apt-get install -y cf8-cli

      - name: ç™»å½• BTP å¹¶åˆ é™¤æ—§ç¯å¢ƒå®ä¾‹ï¼ˆæŒ‰åŒºåŸŸï¼‰
        run: |
          # æ ¹æ®åŒºåŸŸé€‰æ‹©å­è´¦æˆ·ID
          if [ "${{ matrix.region }}" = "sg" ]; then
            SUBACCOUNT_ID="${{ env.SUBACCOUNT_ID_SG }}"
          else
            SUBACCOUNT_ID="${{ env.SUBACCOUNT_ID_US }}"
          fi
          
          btp login --url "${{ env.BTP_CLI_URL }}" --subdomain "aws-us" --user "${{ secrets.EMAIL }}" --password "${{ secrets.PASSWORD }}"
          btp target -s "$SUBACCOUNT_ID"

          echo "ğŸ” æ£€æŸ¥${{ matrix.region }}åŒºåŸŸæ—§ç¯å¢ƒå®ä¾‹æ˜¯å¦å­˜åœ¨..."
          if btp list accounts/environment-instance --subaccount "$SUBACCOUNT_ID" | grep "${{ env.ENV_INSTANCE_NAME }}"; then
            echo "ğŸ§¼ åˆ é™¤${{ matrix.region }}åŒºåŸŸæ—§ç¯å¢ƒå®ä¾‹ï¼š${{ env.ENV_INSTANCE_NAME }}"
            btp delete accounts/environment-instance --subaccount "$SUBACCOUNT_ID" --name "${{ env.ENV_INSTANCE_NAME }}" -f
          else
            echo "âœ… ${{ matrix.region }}åŒºåŸŸæœªå‘ç°æ—§ç¯å¢ƒå®ä¾‹ï¼Œè·³è¿‡åˆ é™¤"
          fi

      - name: åˆ›å»ºæ–°çš„ Cloud Foundry ç¯å¢ƒå®ä¾‹ï¼ˆæŒ‰åŒºåŸŸï¼‰
        run: |
          # æ ¹æ®åŒºåŸŸé€‰æ‹©å­è´¦æˆ·IDå’ŒåŒºåŸŸå‚æ•°
          if [ "${{ matrix.region }}" = "sg" ]; then
            SUBACCOUNT_ID="${{ env.SUBACCOUNT_ID_SG }}"
            REGION="${{ env.REGION_SG }}"
          else
            SUBACCOUNT_ID="${{ env.SUBACCOUNT_ID_US }}"
            REGION="${{ env.REGION_US }}"
          fi
          
          btp create accounts/environment-instance \
            --subaccount "$SUBACCOUNT_ID" \
            --environment cloudfoundry \
            --service cloudfoundry \
            --plan free \
            --parameters "{ \"region\": \"$REGION\" }" \
            --name "${{ env.ENV_INSTANCE_NAME }}-${{ matrix.region }}"  # å®ä¾‹ååŠ åŒºåŸŸåç¼€åŒºåˆ†

      - name: ç­‰å¾…ç¯å¢ƒå®ä¾‹å°±ç»ª
        run: |
          # æ ¹æ®åŒºåŸŸé€‰æ‹©å­è´¦æˆ·ID
          if [ "${{ matrix.region }}" = "sg" ]; then
            SUBACCOUNT_ID="${{ env.SUBACCOUNT_ID_SG }}"
          else
            SUBACCOUNT_ID="${{ env.SUBACCOUNT_ID_US }}"
          fi
          
          INSTANCE_NAME="${{ env.ENV_INSTANCE_NAME }}-${{ matrix.region }}"
          echo "âŒ› ç­‰å¾…${{ matrix.region }}åŒºåŸŸç¯å¢ƒå®ä¾‹å°±ç»ªï¼ˆæœ€é•¿5åˆ†é’Ÿï¼‰..."
          end_time=$((SECONDS + 300))
          while [ $SECONDS -lt $end_time ]; do
            if btp get accounts/environment-instance --subaccount "$SUBACCOUNT_ID" --name "$INSTANCE_NAME" | grep -q "status: RUNNING"; then
              echo "âœ… ${{ matrix.region }}åŒºåŸŸç¯å¢ƒå®ä¾‹å·²å°±ç»ª"
              exit 0
            fi
            sleep 10
          done
          echo "âŒ ${{ matrix.region }}åŒºåŸŸç¯å¢ƒå®ä¾‹åˆ›å»ºè¶…æ—¶"
          exit 1

      - name: ç™»å½• CF å¹¶åˆå§‹åŒ–ç»„ç»‡ç©ºé—´ï¼ˆæŒ‰åŒºåŸŸï¼‰
        run: |
          # æ ¹æ®åŒºåŸŸé€‰æ‹©APIç«¯ç‚¹å’Œç»„ç»‡å
          if [ "${{ matrix.region }}" = "sg" ]; then
            CF_API="${{ env.CF_API_SG }}"
            ORG_NAME="${{ env.ORG_NAME_SG }}"
          else
            CF_API="${{ env.CF_API_US }}"
            ORG_NAME="${{ env.ORG_NAME_US }}"
          fi
          
          echo "ğŸ” ç™»å½•${{ matrix.region }}åŒºåŸŸCFç¯å¢ƒ..."
          cf login -a "$CF_API" -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}"
          
          echo "ğŸ­ å¤„ç†${{ matrix.region }}åŒºåŸŸç»„ç»‡ï¼š$ORG_NAME"
          # æ–°åŠ å¡åŒºåŸŸä½¿ç”¨æä¾›çš„ç»„ç»‡åï¼ˆè‹¥å·²å­˜åœ¨åˆ™å¤ç”¨ï¼‰
          if [ "${{ matrix.region }}" = "sg" ]; then
            if ! cf org "$ORG_NAME" >/dev/null 2>&1; then
              echo "âŒ æ–°åŠ å¡åŒºåŸŸæŒ‡å®šç»„ç»‡ä¸å­˜åœ¨ï¼š$ORG_NAME"
              exit 1
            fi
            echo "âœ… å¤ç”¨æ–°åŠ å¡åŒºåŸŸç°æœ‰ç»„ç»‡ï¼š$ORG_NAME"
          else
            # ç¾å›½åŒºåŸŸåˆ›å»ºæ–°ç»„ç»‡
            cf create-org "$ORG_NAME" || {
              if cf org "$ORG_NAME" >/dev/null 2>&1; then
                echo "âš ï¸ ç¾å›½åŒºåŸŸç»„ç»‡å·²å­˜åœ¨ï¼Œå¤ç”¨ç°æœ‰ç»„ç»‡"
              else
                echo "âŒ ç¾å›½åŒºåŸŸç»„ç»‡åˆ›å»ºå¤±è´¥"
                exit 1
              fi
            }
          fi
          
          # åˆ›å»ºå¹¶åˆ‡æ¢åˆ°ç©ºé—´
          cf create-space "${{ env.SPACE_NAME }}" -o "$ORG_NAME" || true
          cf target -o "$ORG_NAME" -s "${{ env.SPACE_NAME }}"
          echo "âœ… ${{ matrix.region }}åŒºåŸŸCloud Foundryç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
