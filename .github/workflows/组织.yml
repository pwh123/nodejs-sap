name: Cloud Foundry

on:
  workflow_dispatch:

env:
  SUBACCOUNT_ID: "fc63b4dc-2dd2-40fb-92a6-0e82b1b87b45"
  ENV_INSTANCE_NAME: "cf-trial"
  BTP_CLI_URL: "https://cpcli.cf.eu10.hana.ondemand.com"

  # æ–°åŠ å¡åŒºåŸŸé…ç½®
  REGION_SG: "ap21"
  CF_API_SG: "https://api.cf.ap21.hana.ondemand.com"
  ORG_NAME_SG: "adac7863trial_adac7863trial_ext"
  SPACE_NAME_SG: "dev"

  # ç¾å›½åŒºåŸŸé…ç½®
  REGION_US: "us10"
  CF_API_US: "https://api.cf.us10-001.hana.ondemand.com"
  ORG_NAME_US: "adac7863trial_adac7863trial_ext"
  SPACE_NAME_US: "dev"

jobs:
  init_cf_environments:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: å®‰è£… btp CLI
        run: |
          wget https://github.com/SAP-samples/btp-cli-installer/releases/latest/download/btp-cli-linux-amd64.tar.gz -O btp-cli.tar.gz
          tar -xzf btp-cli.tar.gz
          sudo mv btp /usr/local/bin/

      - name: å®‰è£… cf CLI
        run: |
          wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
          echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
          sudo apt-get update && sudo apt-get install -y cf8-cli

      - name: ç™»å½• BTP å¹¶åˆ é™¤æ—§ç¯å¢ƒå®ä¾‹
        run: |
          btp login --url "${{ env.BTP_CLI_URL }}" --subdomain "aws-us" --user "${{ secrets.EMAIL }}" --password "${{ secrets.PASSWORD }}"
          btp target -s "${{ env.SUBACCOUNT_ID }}"

          echo "ğŸ” æ£€æŸ¥æ—§ç¯å¢ƒå®ä¾‹æ˜¯å¦å­˜åœ¨..."
          if btp list accounts/environment-instance --subaccount "${{ env.SUBACCOUNT_ID }}" | grep "${{ env.ENV_INSTANCE_NAME }}"; then
            echo "ğŸ§¼ åˆ é™¤æ—§ç¯å¢ƒå®ä¾‹ï¼š${{ env.ENV_INSTANCE_NAME }}"
            btp delete accounts/environment-instance --subaccount "${{ env.SUBACCOUNT_ID }}" --name "${{ env.ENV_INSTANCE_NAME }}" -f
          else
            echo "âœ… æœªå‘ç°æ—§ç¯å¢ƒå®ä¾‹ï¼Œè·³è¿‡åˆ é™¤"
          fi

      - name: åˆ›å»ºæ–°çš„ Cloud Foundry ç¯å¢ƒå®ä¾‹ï¼ˆæ–°åŠ å¡åŒºåŸŸï¼‰
        run: |
          btp create accounts/environment-instance \
            --subaccount "${{ env.SUBACCOUNT_ID }}" \
            --environment cloudfoundry \
            --service cloudfoundry \
            --plan free \
            --parameters "{ \"region\": \"${{ env.REGION_SG }}\" }"

      - name: ç™»å½• CF å¹¶åˆå§‹åŒ–æ–°åŠ å¡åŒºåŸŸ
        run: |
          cf login -a "${{ env.CF_API_SG }}" -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}"
          cf create-space "${{ env.SPACE_NAME_SG }}" -o "${{ env.ORG_NAME_SG }}" || echo "âš ï¸ ç©ºé—´å·²å­˜åœ¨æˆ–åˆ›å»ºå¤±è´¥"
          cf target -o "${{ env.ORG_NAME_SG }}" -s "${{ env.SPACE_NAME_SG }}"
          echo "âœ… æ–°åŠ å¡åŒºåŸŸåˆå§‹åŒ–å®Œæˆ"

      - name: åˆ›å»ºæ–°çš„ Cloud Foundry ç¯å¢ƒå®ä¾‹ï¼ˆç¾å›½åŒºåŸŸï¼‰
        run: |
          btp create accounts/environment-instance \
            --subaccount "${{ env.SUBACCOUNT_ID }}" \
            --environment cloudfoundry \
            --service cloudfoundry \
            --plan free \
            --parameters "{ \"region\": \"${{ env.REGION_US }}\" }"

      - name: ç™»å½• CF å¹¶åˆå§‹åŒ–ç¾å›½åŒºåŸŸ
        run: |
          cf login -a "${{ env.CF_API_US }}" -u "${{ secrets.EMAIL }}" -p "${{ secrets.PASSWORD }}"
          cf create-space "${{ env.SPACE_NAME_US }}" -o "${{ env.ORG_NAME_US }}" || echo "âš ï¸ ç©ºé—´å·²å­˜åœ¨æˆ–åˆ›å»ºå¤±è´¥"
          cf target -o "${{ env.ORG_NAME_US }}" -s "${{ env.SPACE_NAME_US }}"
          echo "âœ… ç¾å›½åŒºåŸŸåˆå§‹åŒ–å®Œæˆ"
